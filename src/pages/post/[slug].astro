---
export const prerender = true;

import AuthorCard from "@components/blog/AuthorCard.astro";
import BlogNavigation from "@components/blog/BlogNavigation.astro";
import NewsLatter from "@components/blog/NewsLatter.astro";
import RelatedBlogCard from "@components/blog/RelatedBlogCard.astro";
import StickyActionBar from "@components/blog/StickyActionBar.astro";
import TagsFooter from "@components/blog/TagsFooter.astro";
import Layout from "@layouts/Layout.astro";
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
  const blogEntries = await getCollection("posts");
  return blogEntries.map((entry) => ({
    params: { slug: entry.data.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

// Extract SEO data from post
const postTitle = entry.data.title;
const postDescription = entry.data.description || "";
const postImage = entry.data.coverImage || undefined;
const postImageAlt = entry.data.title;
const postTags =
  entry.data.tags?.map((tag: { name: string }) => tag.name) || [];
const postAuthor = entry.data.authors?.[0]?.name || "";
const publishedTime = entry.data.publishedAt?.toISOString();
const modifiedTime = entry.data.updatedAt?.toISOString();

// Helper function to format dates in a user-friendly way
const formatDate = (date: Date | undefined) => {
  if (!date) return "Unknown date";
  return new Intl.DateTimeFormat("es-MX", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(date);
};

// Fetch related posts from the same category (excluding current post)
const allPosts = await getCollection("posts");
const relatedPosts = allPosts
  .filter(
    (post) =>
      post.data.slug !== entry.data.slug &&
      post.data.category?.id === entry.data.category?.id
  )
  .slice(0, 3);
---

<Layout
  title={postTitle}
  description={postDescription}
  image={postImage}
  imageAlt={postImageAlt}
  type="article"
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
  author={postAuthor}
  tags={postTags}
>
  <div class="mx-auto max-w-340 px-4 font-sans sm:px-6 lg:px-8">
    <div class="mx-auto">
      <!-- Content -->
      <article class="w-full px-5 md:px-10">
        <div class="py-8 lg:pe-8">
          <div class="space-y-5 lg:space-y-8">
            <BlogNavigation />
            <h2 class="text-3xl font-bold lg:text-5xl">
              {entry.data.title}
            </h2>
            {
              postImage && (
                <Image
                  src={postImage}
                  alt={postImageAlt}
                  class="w-full rounded-lg"
                  width={700}
                  height={500}
                />
              )
            }

            <div class="flex items-center gap-x-5">
              <span
                class="inline-flex items-center gap-1.5 rounded-full border border-gray-300 bg-gray-100 px-3 py-1 text-xs text-gray-800 hover:bg-gray-200 focus:bg-gray-200 focus:outline-none sm:px-4 sm:py-2 sm:text-sm"
              >
                {entry.data.category?.name || "Uncategorized"}
              </span>
              <p class="text-xs text-gray-800 sm:text-sm">
                {formatDate(entry.data.publishedAt)}
              </p>
            </div>
          </div>
        </div>
        <div class="prose mb-4 max-w-full sm:mb-6">
          <Content />

          <div class="mt-8">
            <TagsFooter tags={entry.data.tags ?? []} />
          </div>
        </div>
        <!-- <NewsLatter /> -->
      </article>
      <!-- End Content -->
    </div>
  </div>
  <!-- <StickyActionBar post={entry} /> -->
</Layout>

<script>
  // Remove autoplay from videos when `prefers-reduced-motion: reduce`
  const autoplayVideos = document.querySelectorAll("video[autoplay]");
  const prefersReducedMotion = window.matchMedia(
    "(prefers-reduced-motion: reduce)"
  ).matches;

  if (prefersReducedMotion) {
    autoplayVideos.forEach((video) => {
      video.removeAttribute("autoplay");
      // Add controls attribute so user can still play the video if they want
      video.setAttribute("controls", "true");
    });
  }
</script>
